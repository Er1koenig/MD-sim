<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Atomistic Simulation of Alloy — Project Page</title>
  <meta name="description" content="Atomistic simulation of a CrCoNi medium-entropy alloy with a gradient nano‑grained structure under cryogenic tensile deformation, plus a robust grain‑rotation analysis pipeline." />
  <meta name="author" content="TAO Yuhao" />

  <!-- Better font delivery (same stack as your homepage) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Lora:ital,wght@0,600;0,700;1,600;1,700&family=Noto+Serif+SC:wght@400;600&display=swap" rel="stylesheet" />

  <!-- Icons (Font Awesome 6 Free) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" integrity="sha512-RhCeKEeyiLdZ28yY7mVt8XzfnOz2bNqsTP7PvpB3qHwD6PPV6cO9HcL7JQhN4F5m2dlHtb1zGuUHmXn4b8vLAw==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Optional: MathJax for LaTeX rendering -->
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

  <style>
    /* ======= Theme tokens (aligned with your homepage) ======= */
    :root{
      --font-sans: "Inter", system-ui, -apple-system, "Segoe UI", "PingFang SC", "Hiragino Sans GB", "Noto Sans CJK SC", "Microsoft YaHei", Arial, sans-serif;
      --font-serif-head: "Lora", "Noto Serif SC", "Songti SC", STSong, Georgia, "Times New Roman", serif;

      --theme-color: #0b2f5b;            /* brand deep blue */
      --theme-color-light: #476d96;      /* link / hover */
      --theme-color-subtle: #e2e8f4;     /* chip bg (light) */

      --bg: #ffffff;                     /* page bg (light) */
      --text: #243447;                   /* main text */
      --muted: #5b6b7b;                  /* secondary */
      --surface: #fafbfd;                /* card bg */
      --border: rgba(11,47,91,.12);      /* soft border */
      --shadow: 0 1px 3px rgba(0,0,0,.05), 0 8px 20px rgba(0,0,0,.06);

      --step--1: clamp(0.88rem, 0.18vw + 0.82rem, 0.96rem);
      --step-0:  clamp(1.00rem, 0.22vw + 0.94rem, 1.08rem);
      --step-1:  clamp(1.125rem, 0.32vw + 1.02rem, 1.25rem);
      --step-2:  clamp(1.35rem, 0.6vw + 1.12rem, 1.55rem);
      --step-3:  clamp(1.62rem, 0.9vw + 1.24rem, 1.95rem);
      --step-4:  clamp(2.15rem, 1.6vw + 1.42rem, 2.6rem);
      --step-5:  clamp(2.8rem,  2.8vw + 1.6rem, 3.6rem);
    }

    /* Polished Dark Theme — mirrors homepage */
    :root.dark{
      color-scheme: dark;
      --bg: #0f1216;
      --text: #e7ebf1;
      --muted: #aab4c1;
      --surface: #131821;
      --border: #293240;
      --theme-color-subtle: color-mix(in srgb, var(--theme-color) 28%, #141a22);
      --shadow: 0 2px 8px rgba(0,0,0,.45), 0 10px 28px rgba(0,0,0,.35);
    }

    html{scroll-behavior:smooth}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family:var(--font-sans); font-size:var(--step-0); line-height:1.7; letter-spacing:.01em;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }

    a{ color: var(--theme-color-light); text-decoration: underline transparent 2px; text-underline-offset:3px; transition: color .2s, text-decoration-color .2s; }
    a:hover{ color: var(--theme-color); text-decoration-color: var(--theme-color); }

    h1,h2,h3,h4{ font-family:var(--font-serif-head); font-weight:600; line-height:1.22; letter-spacing:.006em; margin:0 0 .5rem; }
    h1{ font-size:var(--step-4); }
    h2{ font-size:var(--step-3); }
    h3{ font-size: clamp(1.08rem, 0.6vw + 1rem, 1.32rem); }

    .container{ max-width:1100px; margin:0 auto; padding:0 1.2rem; }

    /* ======= Glassy top header (consistent) ======= */
    #site-header{ position:fixed; inset:0 0 auto 0; height:60px; z-index:1000; display:flex; align-items:center; }
    #site-header .wrap{ width:100%; display:grid; grid-template-columns:auto 1fr auto; gap:1rem; align-items:center; padding:0 .9rem; }
    body:not(.scrolled) #site-header{ background:linear-gradient(180deg, color-mix(in srgb, var(--theme-color) 6%, rgba(255,255,255,.58)) 0%, color-mix(in srgb, var(--theme-color) 6%, rgba(255,255,255,.48)) 100%); border-bottom:1px solid color-mix(in srgb, var(--theme-color) 12%, rgba(0,0,0,.04)); box-shadow:0 1px 2px rgba(0,0,0,.04),0 6px 16px rgba(0,0,0,.05); backdrop-filter: blur(12px) saturate(140%) contrast(1.04); -webkit-backdrop-filter: blur(12px) saturate(140%) contrast(1.04); }
    body.scrolled #site-header{ background:linear-gradient(180deg, color-mix(in srgb, var(--theme-color) 8%, rgba(255,255,255,.90)) 0%, color-mix(in srgb, var(--theme-color) 8%, rgba(255,255,255,.84)) 100%); border-bottom:1px solid color-mix(in srgb, var(--theme-color) 22%, rgba(0,0,0,.08)); box-shadow:0 2px 6px rgba(0,0,0,.06),0 10px 26px rgba(0,0,0,.08); }
    :root.dark body:not(.scrolled) #site-header{ background: linear-gradient(180deg, color-mix(in srgb, var(--theme-color) 16%, rgba(16,18,22,.78)) 0%, color-mix(in srgb, var(--theme-color) 16%, rgba(16,18,22,.70)) 100%); border-bottom:1px solid color-mix(in srgb, var(--theme-color) 32%, rgba(255,255,255,.08)); box-shadow:0 1px 3px rgba(0,0,0,.55), 0 10px 26px rgba(0,0,0,.44) }
    :root.dark body.scrolled #site-header{ background: linear-gradient(180deg, color-mix(in srgb, var(--theme-color) 18%, rgba(16,18,22,.86)) 0%, color-mix(in srgb, var(--theme-color) 18%, rgba(16,18,22,.80)) 100%); border-bottom-color: color-mix(in srgb, var(--theme-color) 40%, rgba(255,255,255,.10)); }

    .brand{ display:flex; align-items:center; gap:.6rem; font-weight:700; color:var(--theme-color); text-decoration:none; }
    .brand .logo{ width:26px; height:26px; display:grid; place-items:center; border-radius:6px; background: color-mix(in srgb, var(--theme-color) 16%, #fff); box-shadow: inset 0 0 0 1px color-mix(in srgb, var(--theme-color) 30%, rgba(0,0,0,.08)); font-size:.95rem; }
    .brand span{ color: var(--theme-color); letter-spacing:.02em; }

    nav.site-nav ul{ display:flex; align-items:center; gap:1.2rem; list-style:none; margin:0; padding:0; }
    nav.site-nav a{ color:#4b5563; text-decoration:none; font-weight:500; font-size:clamp(.92rem, .2vw + .84rem, 1rem); }
    nav.site-nav a:hover, nav.site-nav a.active{ color:var(--theme-color); }
    :root.dark nav.site-nav a{ color: var(--muted); }

    .spacer{ height:1px; }

    /* Theme button (single-cycle: light → dark → auto) */
    .theme-btn{ display:inline-flex; align-items:center; justify-content:center; width:36px; height:36px; border-radius:9999px; border:1px solid rgba(0,0,0,.12); background:rgba(255,255,255,.65); backdrop-filter: blur(8px) saturate(140%); -webkit-backdrop-filter: blur(8px) saturate(140%); cursor:pointer; font-size:1rem; line-height:1; color:#333; transition: background .2s, border-color .2s, transform .02s, opacity .2s; opacity:.95; }
    .theme-btn:hover{ opacity:1; border-color:rgba(0,0,0,.2) }
    .theme-btn:active{ transform: translateY(1px); }
    :root.dark .theme-btn{ background: rgba(20,24,31,.72); border-color: rgba(255,255,255,.12); color: var(--text); }

    /* ======= Masthead ======= */
    .masthead{ position:relative; height: 56vh; min-height: 380px; display:grid; place-items:center; text-align:center; color:#F3F2E3; background: radial-gradient(110% 80% at 50% 46%, rgba(0,0,0,.12) 0%, rgba(0,0,0,.32) 52%, rgba(0,0,0,.6) 100%), url('image/header.jpg') center/cover no-repeat; }
    .masthead::after{ content:""; position:absolute; inset:0; background: linear-gradient(180deg, rgba(11,47,91,.18) 0%, rgba(11,47,91,.22) 55%, rgba(11,47,91,.18) 100%); box-shadow: inset 0 0 80px rgba(0,0,0,.18); }
    :root.dark .masthead{ text-shadow: 0 1px 16px rgba(0,0,0,.28); }
    .masthead .inner{ position:relative; z-index:1; padding:0 1rem; }
    .masthead h1{ font-size: clamp(2.1rem, 4.5vw, 3.8rem); margin:.2rem 0; font-weight:700; }
    .masthead .subtitle{ font-size: clamp(1rem, 0.7vw + .9rem, 1.2rem); opacity:.95; letter-spacing:.4px; }
    .scroll-down{ display:inline-block; margin-top:1rem; font-size:1.35rem; color:#F3F2E3; text-decoration:none; animation:scrollHint 1.2s infinite; }
    .scroll-down:hover{ color: var(--theme-color); text-decoration:none; }
    @keyframes scrollHint{ 0%{transform:translateY(0)} 50%{transform:translateY(6px)} }

    /* ======= Sections ======= */
    section[id]{ scroll-margin-top: 88px; }
    .section{ padding: 2.2rem 0; }

    .section-title{ position:relative; font-size: var(--step-2); margin: 0 0 1rem; }
    .section-title::after{ content:""; position:absolute; left:0; bottom:-.45rem; width:3rem; height:3px; background:var(--theme-color); border-radius:1px; }

    /* Lead intro block */
    .lead{ display:grid; grid-template-columns: 1.5fr .9fr; gap:1.4rem; align-items:start; }
    @media (max-width: 900px){ .lead{ grid-template-columns: 1fr; } }

    .card{ background: var(--surface); border-radius: 14px; padding: 1rem 1.1rem; box-shadow: var(--shadow); border: 1px solid var(--border); }
    .muted{ color: var(--muted); }

    .btns{ display:flex; flex-wrap:wrap; gap:.6rem; margin:.8rem 0 0; }
    .btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.52rem .9rem; border-radius: 9px; text-decoration:none; font-weight:600; letter-spacing:.02em; border:1px solid currentColor; transition: transform .02s, background .2s, color .2s, border-color .2s; }
    .btn:active{ transform: translateY(1px); }
    .btn-primary{ color:#fff; background: var(--theme-color); border-color: transparent; }
    .btn-primary:hover{ filter: brightness(1.02) saturate(1.02); }
    .btn-ghost{ color: var(--theme-color); background: transparent; border-color: color-mix(in srgb, var(--theme-color) 48%, currentColor); }
    .btn-ghost:hover{ background: color-mix(in srgb, var(--theme-color) 8%, #fff); }
    :root.dark .btn-ghost:hover{ background: color-mix(in srgb, var(--theme-color) 16%, #0f1216); }

    /* Chips (Highlights) */
    .highlights{ display:flex; flex-wrap:wrap; gap:.45rem .6rem; padding:0; margin: .3rem 0 0; list-style:none; }
    .highlights li{ background: var(--theme-color-subtle); border-radius:9999px; padding:.16rem .65rem; font-size:.92rem; font-weight:600; letter-spacing:.02em; color: var(--theme-color); }
    .highlights li::before{ content:"• "; }

    /* Media */
    .media{ margin: 1.2rem 0 0; }
    .video-wrap{ display:grid; place-items:center; margin:.8rem 0 0; }
    video, .media img{ width:min(980px, 92vw); height:auto; border-radius: 10px; border:1px solid var(--border); box-shadow: var(--shadow); }

    /* Two-column detail */
    .grid-2{ display:grid; grid-template-columns: 1fr 1fr; gap:1.1rem; }
    @media (max-width: 900px){ .grid-2{ grid-template-columns: 1fr; } }

    /* Figure gallery */
    .gallery{ display:grid; grid-template-columns: 1fr; gap: 1rem; }
    .fig{ background: var(--surface); border:1px solid var(--border); border-radius: 12px; box-shadow: var(--shadow); padding: .8rem; }
    .fig img{ width:100%; height:auto; border-radius:8px; }
    .fig .cap{ font-size:.95rem; color:var(--muted); margin:.4rem 0 0; }

    /* Footer note */
    .foot{ display:flex; justify-content:space-between; align-items:center; gap:.8rem; padding:1.2rem 0 2rem; border-top:1px dashed var(--border); margin-top:2rem; color:var(--muted); }

    /* Small helper */
    .inline-icon{ height: 1em; width:auto; vertical-align: -.15em; margin-right:.25em; border-radius:2px; }

  </style>
</head>
<body>
  <a id="top"></a>

  <!-- ======= Fixed site header (glassy) ======= -->
  <header id="site-header">
    <div class="wrap container">
      <a class="brand" href="index.html" title="Back to Home">
        <span class="logo"><i class="fa-solid fa-cube"></i></span>
        <span>TAO&nbsp;Yuhao</span>
      </a>

      <nav class="site-nav">
        <ul>
          <li><a href="#overview" class="active">Overview</a></li>
          <li><a href="#rotation">Rotation&nbsp;Algorithm</a></li>
          <li><a href="#figures">Figures</a></li>
          <li><a href="#resources">Resources</a></li>
        </ul>
      </nav>

      <button id="theme-btn" class="theme-btn" type="button" aria-label="Theme: Light (click to change)" title="Theme: Light"><span id="theme-ico">☀︎</span></button>
    </div>
  </header>

  <!-- ======= Hero / Masthead ======= -->
  <section class="masthead">
    <div class="inner">
      <h1>Atomistic Simulation of Alloy</h1>
      <p class="subtitle">CrCoNi MEA · Gradient Nano‑Grained (GNG) · Cryogenic Tensile Deformation</p>
      <a href="#overview" class="scroll-down" aria-label="Scroll to overview">▼</a>
    </div>
  </section>

  <main class="container">
    <!-- ================= Overview ================= -->
    <section id="overview" class="section">
      <h2 class="section-title">Part I — Paper Overview</h2>
      <div class="lead">
        <div>
          <p>
            This work reports large‑scale molecular dynamics (MD) simulations of a CrCoNi medium‑entropy alloy (MEA) featuring a
            <strong>gradient nano‑grained (GNG)</strong> architecture under <strong>cryogenic</strong> uniaxial tension (≈ 15% true strain).
            We observe strong strain hardening through the elasto‑plastic transition; post‑yield, <em>strain partitioning</em> develops across grain‑size zones. Stacking‑fault activity—used as a proxy for dislocation processes—shows grain‑size dependence and supports
            <strong>hetero‑deformation induced (HDI)</strong> hardening. The GNG structure exhibits superior flow stress compared to a rule‑of‑mixtures estimate from homogeneous nano‑grained counterparts.
          </p>

          <ul class="highlights">
            <li>Large‑scale MD of GNG vs. homogeneous NG</li>
            <li>Elasto‑plastic transition & strong hardening</li>
            <li>Strain partitioning across grain‑size zones</li>
            <li>Stacking‑fault activity as dislocation proxy</li>
            <li>HDI hardening & superior flow stress</li>
          </ul>

          <div class="btns">
            <a class="btn btn-primary" href="data/fmats-09-1118952.pdf" target="_blank" rel="noopener"><i class="fa-solid fa-file-pdf"></i> Full Paper (PDF)</a>
            <a class="btn btn-ghost" href="https://www.frontiersin.org/journals/materials/articles/10.3389/fmats.2022.1118952/full" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> Journal Page</a>
          </div>

          <div class="media">
            <h3>Structural Evolution During Tensile Deformation</h3>
            <p class="muted">GNG‑structured model under tensile strain. FCC atoms hidden; blue = HCP atoms, red = others.</p>
            <div class="video-wrap">
              <video id="grainGrowthDemo" controls preload="metadata" poster="preview.png">
                <source src="image/mdsim_tensile.mp4" type="video/mp4" />
                Your browser does not support HTML5 video.
              </video>
            </div>
          </div>
        </div>

        <!-- Right column: Fast facts card -->
        <aside class="card">
          <h3 style="margin-bottom:.4rem">Fast Facts</h3>
          <ul style="margin:.2rem 0 0 1.1rem; padding:0;">
            <li>Alloy: CrCoNi (MEA)</li>
            <li>Architecture: Gradient nano‑grained (GNG)</li>
            <li>Loading: Uniaxial tension · cryogenic</li>
            <li>Max strain ≈ 15% (true)</li>
            <li>Key metrics: flow stress, stacking fault activity</li>
          </ul>
          <hr style="border:none; border-top:1px dashed var(--border); margin:.8rem 0;" />
          <div>
            <span class="muted">BibTeX</span>
            <details style="margin-top:.4rem;">
              <summary class="btn btn-ghost" style="display:inline-flex;">Show BibTeX</summary>
              <pre style="white-space:pre-wrap; background:transparent; border:1px dashed var(--border); border-radius:8px; padding:.7rem; margin-top:.5rem; font-size:.9rem;">
@article{tao2023MEA,
  title   = {Atomistic tensile deformation mechanisms in a CrCoNi medium-entropy alloy with gradient nano-grained structure at cryogenic temperature},
  author  = {Tao Y, Cheng W and Wang W},
  journal = {Frontiers in Materials},
  year    = {2023},
  doi     = {10.3389/fmats.2022.1118952}
}
              </pre>
            </details>
          </div>
        </aside>
      </div>
    </section>

    <!-- ================= Rotation Algorithm ================= -->
    <section id="rotation" class="section">
      <h2 class="section-title">Part II — Grain Rotation Analysis Algorithm</h2>
      <p>
        We provide a lean, validation‑friendly pipeline that converts OVITO‑exported quaternions and LAMMPS dumps into
        <strong>per‑grain rotation metrics</strong> plus an <strong>OVITO‑verifiable point cloud</strong>.
        The pipeline is designed for robustness in the presence of twinning, grain‑boundary motion, and bent grains.
      </p>

      <div class="grid-2" style="margin-top:.8rem;">
        <div class="card">
          <h3>What the Pipeline Does</h3>
          <ul style="margin:.4rem 0 0 1.1rem;">
            <li><strong>Global defect mask</strong>: flag atoms that are non‑FCC at least once and exclude them from stats.</li>
            <li><strong>Baseline orientation (0%)</strong>: normalize quaternion→angle (z‑axis) to avoid branch/symmetry jumps.</li>
            <li><strong>Per‑frame rotation</strong>: convert rotation quaternions to z‑angles; wrap to <code>[-45°, 45°]</code> (⟨001⟩ 90° symmetry).</li>
            <li><strong>Main‑peak selection</strong>: 5° grain‑wise histogram; pick adjacent dominant peak to suppress twins/noise.</li>
            <li><strong>Relative rotation</strong>: compute each grain’s mean difference to neighbors; aggregate by grain‑size zone.</li>
            <li><strong>OVITO verification</strong>: export only main‑peak atoms (<code>id, rot, x, y, z</code>) for color mapping.</li>
          </ul>
          <div class="btns" style="margin-top:.8rem;">
            <a class="btn btn-ghost" href="https://github.com/Er1koenig/MD-sim/blob/main/Rotation_new.m" target="_blank" rel="noopener"><i class="fa-brands fa-github"></i> Code (Matlab)</a>
          </div>
        </div>
        <div class="card">
          <h3>Rotation vs. Strain</h3>
          <p class="muted" style="margin:.15rem 0 .6rem;">Absolute rotation angle vs. applied tensile strain on a GNG‑structured model.</p>
          <img src="image/rot_evolution.png" alt="Absolute rotation angle vs. applied tensile strain" style="width:100%; height:auto; border-radius:10px; border:1px solid var(--border);" />
        </div>
      </div>
    </section>

    <!-- ================= Figures ================= -->
    <section id="figures" class="section">
      <h2 class="section-title">Robustness in Twins, GB Motion, and Bent Grains</h2>
      <div class="gallery">
        <figure class="fig">
          <img src="image/twinning.png" alt="Twinning regions identified and trimmed by the main‑peak range" />
          <figcaption class="cap">Twinning regions are identified and trimmed via main‑peak range.</figcaption>
        </figure>

        <figure class="fig">
          <img src="image/gb_motion.png" alt="Grain boundary motion impact on rotation distribution" />
          <figcaption class="cap">FCC atoms of an adjacent grain are excluded to mitigate GB motion effects.</figcaption>
        </figure>

        <figure class="fig">
          <img src="image/bending.png" alt="Bent grains and their rotation spread handled by peak‑selection logic" />
          <figcaption class="cap">Bent grains and their broadened rotation spread are handled through the peak‑selection logic.</figcaption>
        </figure>
      </div>
    </section>

    <!-- ================= Resources / Links ================= -->
    <section id="resources" class="section">
      <h2 class="section-title">Resources</h2>
      <div class="card">
        <div class="btns">
          <a class="btn btn-primary" href="data/fmats-09-1118952.pdf" target="_blank" rel="noopener"><i class="fa-solid fa-file-pdf"></i> Full Paper (PDF)</a>
          <a class="btn btn-ghost" href="https://www.frontiersin.org/journals/materials/articles/10.3389/fmats.2022.1118952/full" target="_blank" rel="noopener"><i class="fa-solid fa-up-right-from-square"></i> Journal Page</a>
          <a class="btn btn-ghost" href="https://er1koenig.github.io/MD-sim/" target="_blank" rel="noopener"><i class="fa-solid fa-globe"></i> Project Page</a>
          <a class="btn btn-ghost" href="https://github.com/Er1koenig/MD-sim/blob/main/Rotation_new.m" target="_blank" rel="noopener"><i class="fa-brands fa-github"></i> Code (Matlab)</a>
        </div>
        <p class="muted" style="margin-top:.8rem;">For datasets and additional figures, please contact the authors.</p>
      </div>

      <div class="foot">
        <div>© TAO Yuhao · Atomistic Simulation of Alloy</div>
        <div><a href="#top">Back to top ↑</a></div>
      </div>
    </section>
  </main>

  <!-- ======= Interaction scripts: elevation, scroll‑spy, theme switch ======= -->
  <script>
    // Elevation on scroll
    const onScrollShadow = () => document.body.classList.toggle('scrolled', window.scrollY > 4);
    window.addEventListener('scroll', onScrollShadow); onScrollShadow();

    // Simple Scroll‑Spy (nav active state)
    const navLinks = [...document.querySelectorAll('nav.site-nav a')];
    const anchors = [...document.querySelectorAll('main section[id]')].sort((a,b)=>a.offsetTop-b.offsetTop);
    function onScrollSpy(){
      const pos = window.scrollY + 120;
      let cur = anchors[0];
      for(const s of anchors){ if(pos >= s.offsetTop) cur = s; else break; }
      navLinks.forEach(a => a.classList.toggle('active', a.getAttribute('href').slice(1) === '#' + cur.id));
    }
    window.addEventListener('scroll', onScrollSpy); onScrollSpy();

    // === Single Button Theme Switcher (☀︎ → ☾ → ◐) ===
    (function(){
      const docEl = document.documentElement;
      const prefersDark = window.matchMedia('(prefers-color-scheme: dark)');
      const btn = document.getElementById('theme-btn');
      const ico = document.getElementById('theme-ico');
      const STORAGE_KEY = 'theme'; // 'light' | 'dark' | 'auto'

      const chars = { light: '☀︎', dark: '☾', auto: '◐' };
      const titles = {
        light: 'Theme: Light',
        dark:  'Theme: Dark',
        auto:  'Theme: Auto (follows system)'
      };

      function setIcon(mode){ if(!ico||!btn) return; ico.textContent = chars[mode]; btn.setAttribute('aria-label', titles[mode] + ' (click to change)'); btn.setAttribute('title', titles[mode]); btn.dataset.mode = mode; }
      function applyTheme(mode, persist = true){ const isDark = (mode === 'dark') || (mode === 'auto' && prefersDark.matches); docEl.classList.toggle('dark', isDark); setIcon(mode); if(persist) localStorage.setItem(STORAGE_KEY, mode); }
      function nextMode(cur){ if(cur==='light') return 'dark'; if(cur==='dark') return 'auto'; return 'light'; }

      const saved = localStorage.getItem(STORAGE_KEY) || 'light';
      applyTheme(saved, false);

      if(btn){ btn.addEventListener('click', () => { const cur = btn.dataset.mode || saved || 'light'; applyTheme(nextMode(cur)); }); }
      prefersDark.addEventListener('change', () => { const cur = localStorage.getItem(STORAGE_KEY) || 'light'; if(cur==='auto') applyTheme('auto', false); });
    })();
  </script>
</body>
</html>
